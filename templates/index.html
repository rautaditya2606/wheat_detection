{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white rounded-lg shadow-lg p-8">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Upload Wheat Image</h2>
    
    <form id="uploadForm" method="post" enctype="multipart/form-data" class="space-y-6">
        <div class="file-upload-area flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-8 bg-gray-50 hover:bg-gray-100 transition-colors">
            <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p class="upload-text text-gray-600 mb-4">Drag & drop an image here or click to select</p>
            <div class="relative">
                <input type="file" name="file" id="file-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <label for="file-upload" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 cursor-pointer transition-colors">
                    Choose Image
                </label>
            </div>
            <p id="fileName" class="mt-2 text-sm text-gray-500">No file chosen</p>
        </div>
        
        <button type="submit" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition-colors">
            Analyze Image
        </button>
    </form>
    <div class="mt-8 text-center text-gray-600">
        <p>Supported formats: JPG, JPEG, PNG</p>
    </div>
</div>

<!-- How It Works Section -->
<div class="max-w-3xl mx-auto mt-12 bg-white rounded-lg shadow-lg p-8">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">How It Works</h2>
    
    <div class="space-y-6">
        <div class="flex items-start">
            <div class="flex-shrink-0 bg-green-100 rounded-full p-2">
                <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">Quick Analysis (No Login Required)</h3>
                <p class="mt-1 text-gray-600">
                    Simply upload a photo of your wheat crop to get an instant prediction about its health condition. 
                    My pre-trained ResNet50(it is trained on ImageNet dataset) model will analyze the image and provide you with a basic assessment in seconds.
                </p>
            </div>
        </div>

        <div class="flex items-start">
            <div class="flex-shrink-0 bg-blue-100 rounded-full p-2">
                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">Personalized Analysis (Login Required)</h3>
                <p class="mt-1 text-gray-600">
                    For more detailed and personalized recommendations, create an account and complete our quick questionnaire. 
                    The questionnaire will ask about your farming practices, location, and crop history to provide tailored advice for your specific situation.
                </p>
            </div>
        </div>

        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-8">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Note:</strong> For the most accurate results, upload photos that are taken in good lighting and ensure the wheat plants are clearly visible. 
                        The more details the model can see, the better analysis it can provide.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-upload');
            const uploadForm = document.getElementById('uploadForm');
            const analyzeBtn = uploadForm ? uploadForm.querySelector('button[type="submit"]') : null;
            const fileNameDisplay = document.getElementById('fileName');
            
            if (!uploadForm || !analyzeBtn || !fileInput) {
                console.error('Required form elements not found');
                return;
            }
            
            // Update file name display
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files && e.target.files[0];
                const fileName = file ? file.name : 'No file chosen';
                fileNameDisplay.textContent = fileName;
                
                // Update button state
                updateButtonState(!!file);
            });
            
            // Handle form submission
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    showAlert('Please select an image to analyze', 'error');
                    return false;
                }
                
                // Show loading state
                const originalText = analyzeBtn.innerHTML;
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = 'Analyzing... <i class="fas fa-spinner fa-spin ml-2"></i>';
                analyzeBtn.classList.add('opacity-75');
                
                try {
                    const formData = new FormData(uploadForm);
                    const response = await fetch('/predict', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to process image');
                    }
                    
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else if (data.error) {
                            throw new Error(data.error);
                        } else if (data.success) {
                            // If we have the data, render the result directly
                            const resultUrl = new URL(window.location.href);
                            resultUrl.pathname = '/result';
                            resultUrl.search = new URLSearchParams({
                                label: data.label,
                                image_path: data.image_url,
                                weather_data: JSON.stringify(data.weather_data)
                            }).toString();
                            window.location.href = resultUrl.toString();
                        } else {
                            window.location.reload();
                        }
                    } else {
                        // If not JSON, assume it's HTML content
                        const html = await response.text();
                        document.open();
                        document.write(html);
                        document.close();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showAlert(error.message || 'An error occurred. Please try again.', 'error');
                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = originalText;
                    analyzeBtn.classList.remove('opacity-75');
                }
                
                return false;
            });
            
            // Show alert message
            function showAlert(message, type = 'info') {
                // Remove any existing alerts
                const existingAlert = document.querySelector('.alert-message');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert-message fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${
                    type === 'error' ? 'bg-red-500' : 'bg-green-500'
                }`;
                alertDiv.textContent = message;
                
                // Add close button
                const closeButton = document.createElement('button');
                closeButton.className = 'ml-4';
                closeButton.innerHTML = '&times;';
                closeButton.onclick = () => alertDiv.remove();
                alertDiv.appendChild(closeButton);
                
                // Add to page
                document.body.appendChild(alertDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => alertDiv.remove(), 300);
                }, 5000);
            }
            
            // Update button state
            function updateButtonState(isEnabled) {
                analyzeBtn.disabled = !isEnabled;
                if (isEnabled) {
                    analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // Initial state
            updateButtonState(false);
        });
    </script>
{% endblock %}
