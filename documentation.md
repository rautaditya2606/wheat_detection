# Project Documentation: Wheat Disease Classifier

## üìå Overview
The **Wheat Disease Classifier** is a state-of-the-art AI-powered precision agriculture platform. It empowers farmers to diagnose 15 different wheat pathologies instantly using computer vision and receive localized treatment plans generated by Generative AI (LLMs). The system integrates environmental context (weather), farm-specific data (soil, irrigation), and spatial intelligence (GPS) to provide actionable insights.

---

## üõ† Tech Stack & Architecture

### Backend Core
- **Framework**: [Flask 3.0.0](https://flask.palletsprojects.com/) (WSGI/ASGI compatible)
- **CORS**: Enabled for Next.js cross-origin communication.
- **Asynchronous Adapter**: `asgiref` for bridging WSGI and ASGI (Uvicorn).
- **Security**: 
  - `Flask-Login` for session management.
  - `Werkzeug` for secure password hashing (PBKDF2).
  - CSRF protection via `Flask-WTF`.

### Machine Learning Stack
- **Architecture**: **ResNet50** (50-layer Residual Network).
- **Optimization Engine**: [ONNX Runtime](https://onnxruntime.ai/).
- **Generative AI**: `google-generativeai` (Gemini Pro) for expert-level diagnostic reports.

### Data & Persistence
- **Identity Storage**: `users.json` ‚Äì persists user profiles and credentials.
- **Response Tracking**: `user_responses.json` ‚Äì maintains a history of user interactions and diagnoses.
- **Configuration**: `.env` driven environment variables for API keys and secrets.

---

## üß† Diagnostic Engine: ResNet50 & ONNX

### 1. Model Lifecycle
The model transitions from development to production through a specialized pipeline:
- **Training**: Developed in PyTorch with a custom fully connected layer for 15 classes.
- **Conversion**: The `convert_to_onnx.py` script exports the model with **Constant Folding** and **Dynamic Axes** (for batch size flexibility).
- **Production**: ONNX Runtime provides a 2x-4x speedup on CPU compared to native PyTorch.

### 2. Preprocessing Specification
Every image undergoes a rigorous transformation before inference:
- **Resizing**: Bilinear interpolation to $224 \times 224$ pixels.
- **Normalization**: Standardized using ImageNet statistics:
  - $\text{Mean} = [0.485, 0.456, 0.406]$
  - $\text{Std} = [0.229, 0.224, 0.225]$
- **Tensor Format**: NCHW (Batch, Channels, Height, Width).

---

## üå© Multi-Factor Recommendation Engine

The application doesn't just predict a disease; it builds a comprehensive clinical picture using:

| Data Source | Content | Purpose |
|-------------|---------|---------|
| **CV Model** | Disease Name & Confidence | Primary diagnosis. |
| **WeatherAPI** | Temp, Humidity, Rainfall | Assessing environmental risk for disease spread. |
| **User Data** | Soil Type, Fertilizer, Previous Crop | Understanding farm history and management. |
| **Gemini AI** | Dynamic HTML Response | Tailored treatment and prevention strategies. |

---

## üìç Spatial Intelligence (Geolocation)

The platform implements a **Dual-Layer Geolocation** strategy:
1.  **Primary (Browser Geolocation API)**: High-accuracy GPS coordinates (requires user permission).
2.  **Fallback (IP-based Geolocation)**: Uses `ip-api.com` or `ipinfo.io` to estimate location when GPS is unavailable.
3.  **Reverse Geocoding**: Converts coordinates into human-readable addresses using the **OpenStreetMap Nominatim** service.

---

## üöÄ Deployment & Configuration

### Environment Variables
Configure these in your `.env` file:
```bash
SECRET_KEY="your-secret-key"
GEMINI_API_KEY="AIzaSy..."
WEATHER_API_KEY="your-weatherapi-key"
ENV="production" # or "development"
```

### Production Setup
Managed by **Gunicorn** for process management and **Uvicorn** for ASGI handling:
- **Workers**: 2 per core recommendation.
- **Binding**: Listens on `0.0.0.0:10000`.
- **Static Assets**: Handled by Flask with `send_from_directory`.

---

## üåæ Comprehensive Benefits for Farmers

- **Rapid Response**: Reduces the "time-to-treatment" from days to seconds.
- **Cost Reduction**: Prevents the purchase of unnecessary or incorrect chemicals through precise identification.
- **Environmental Stewardship**: Promotes integrated pest management by suggesting long-term biological and cultural controls.
- **Knowledge Democratization**: Brings Ph.D.-level agricultural expertise to remote areas via an LLM-powered advisor.
- **Historical Tracking**: Farmers can view previous diagnoses to identify patterns in soil health and disease cycles.

---

## üìÅ Repository Structure
- `app.py`: Main application controller and routing logic.
- `models.py`: User identity and profile management.
- `location.py`: Geolocation services.
- `utils.py`: External API integrations (Weather/Gemini).
- `user_data.py`: Questionnaire and response persistence.
- `static/js/`: Client-side logic for location and UI interactions.
- `templates/`: Jinja2-powered responsive HTML views.
- `wheat_resnet50.onnx`: The production-ready model artifact.
